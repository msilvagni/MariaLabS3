---
title: "Lab 13"
author: "Maria Silvagni"
format:
  html:
    toc: true
    toc_float: true
    embed-resources: true
execute: 
  warning: false
  message: false
---
# Analysis of the NEON soilMAGs soilChem Data
## Comprehensive Microbial Co-occurrence and Network Analysis

```{r}
library(tidyverse)
library(igraph)
library(ggraph)
library(tidygraph)
library(readr)
library(visNetwork)
library(plotly)
```

```{r}
library(tidyverse)

url <- "https://github.com/jeffreyblanchard/PathoGen2025/raw/main/labs/NEON_soilMAGs_soilChem.csv"
soil_data <- read_csv(url)
```

```{r setup, include=FALSE}
library(tidyverse)
library(janitor)

# Read in your CSV (adjust filename/path if needed)
soilMAGs <- read_csv("NEON_soilMAGs_soilChem.csv") |>
  clean_names()

# Quick check
glimpse(soilMAGs)
```

```{r}
glimpse(soilMAGs)
```

```{r}
glimpse(soil_data)
```

```{r}
library(tidyverse)
library(janitor)
library(skimr)
library(patchwork)
library(ggrepel)



# Select only columns we’ll analyze (drop big NA genomics fields)
soil_env <- soil_data %>%
  select(genomicsSampleID, site_ID, decimalLatitude, decimalLongitude,
         elevation, soilTemp, soilMoisture, soilInWaterpH = soilInWaterpH,
         soilInCaClpH = soilInCaClpH)

# Parse metadata: sample type inferred from ID suffix: "-M-" vs "-O-"
soil_env <- soil_env %>%
  mutate(sample_type = case_when(
    str_detect(genomicsSampleID, "-M-") ~ "M",  # mineral horizon
    str_detect(genomicsSampleID, "-O-") ~ "O",  # organic horizon
    TRUE ~ "unknown"
  )) %>%
  mutate(site_iD = factor(site_ID),
         sample_type = factor(sample_type, levels = c("M","O","unknown")))

```

```{r}
# Summary skim
skim(soil_env)

# Missingness by variable
soil_env %>%
  summarize(across(everything(), ~sum(is.na(.)))) %>%
  pivot_longer(everything(), names_to = "variable", values_to = "n_missing") %>%
  arrange(desc(n_missing))

```

## Comprehensive Community Composition & Diversity Analysis of NEON MAGs by SiteID

For my lab, I mainly focused on community/ environmental correlations and community composition & diversity. With the help of Co-pilot, I made some really interesting plots! 

Cross-site environmental ranges
```{r}
site_summary <- soil_env %>%
  group_by(site_ID) %>%
  summarize(n = n(),
            elev_mean = mean(elevation, na.rm = TRUE),
            temp_mean = mean(soilTemp, na.rm = TRUE),
            moist_mean = mean(soilMoisture, na.rm = TRUE),
            phw_mean = mean(soilInWaterpH, na.rm = TRUE),
            phc_mean = mean(soilInCaClpH, na.rm = TRUE)) %>%
  arrange(desc(elev_mean))

site_summary

```

This summarizes how elevation, temperature, moisture, and pH vary across NEON sites. Sites like NIWO/TOOL/YELL have high elevation and cooler soils. SRER/ONAQ/CLBJ show warmer, usually drier conditions. I expect moisture and pH gradients to be effected by climate.

## Relationship between pH in water vs CaCl2

```{r}
p_ph <- soil_env %>%
  ggplot(aes(soilInWaterpH, soilInCaClpH, color = site_ID)) +
  geom_point(alpha = 0.7) +
  geom_abline(slope = 1, intercept = 0, linetype = "dashed") +
  labs(x = "pH (water)", y = "pH (CaCl2)",
       title = "pH in water vs pH in CaCl2 across NEON sites") +
  theme_bw()

p_ph

# Fit regression
lm_ph <- lm(soilInCaClpH ~ soilInWaterpH, data = soil_env)
summary(lm_ph)

```

This shows CaCl₂ pH and water pH levels and their correlation (in this case strongly).CaCl2 pH is usually lower than water pH (points below 1:1 line), whcih reflects ionic strength effects. The regression slope, is close to 1 and indicates a consistent pattern. I think the site-specific minerals/organic matter cause this shift.

## Sample-type contrasts (O vs M): pH, moisture, temperature

```{r}
soil_long <- soil_env %>%
  pivot_longer(cols = c(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH),
               names_to = "variable", values_to = "value")

p_type <- soil_long %>%
  filter(sample_type != "unknown") %>%
  ggplot(aes(sample_type, value, fill = sample_type)) +
  geom_violin(trim = TRUE, alpha = 0.6) +
  geom_boxplot(width = 0.15, outlier.shape = NA) +
  facet_wrap(~variable, scales = "free_y") +
  scale_fill_brewer(palette = "Dark2") +
  labs(title = "Organic vs mineral horizons across variables",
       x = "Sample type", y = "Value") +
  theme_bw()

p_type

```

This shows the organic horizons versus mineral horizons and how their environmental factors are different. Here, you can see that the organic horizons (O) should be moister and more acidic (lower pH) than mineral (M). If O samples were taken from the forest floor, I would think temperature would be lower. This figure displays the differences visible across sites due to th horizons.

## Elevation gradients: Temperature, Moisture, and pH

```{r}
p_elev_temp <- ggplot(soil_env, aes(elevation, soilTemp, color = site_ID)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Elevation (m)", y = "Soil temperature (°C)",
       title = "Elevation vs soil temperature") + theme_bw()

p_elev_moist <- ggplot(soil_env, aes(elevation, soilMoisture, color = site_ID)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Elevation (m)", y = "Volumetric moisture",
       title = "Elevation vs soil moisture") + theme_bw()

p_elev_ph <- ggplot(soil_env, aes(elevation, soilInWaterpH, color = site_ID)) +
  geom_point() + geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Elevation (m)", y = "pH (water)",
       title = "Elevation vs soil pH") + theme_bw()

p_elev_temp / p_elev_moist / p_elev_ph

```

This shows the characteristic differences at different elevations. I concluded that temperature declines as elevation increases. Moisture vs elevation can change depending on the region (ex. alpine sites may be moist or dry). pH is often lower at high elevations.

## Temperature–moisture coupling across climate regimes

```{r}
p_tm <- ggplot(soil_env, aes(soilTemp, soilMoisture, color = site_ID)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "Soil temperature (°C)", y = "Volumetric moisture",
       title = "Temperature–moisture relationship varies by site") +
  theme_bw()

p_tm
```

This highlights the soil temperature and how they differ depedning on the site. My ecological interpretation of this graph is that in grasslands (SRER, ONAQ), there is often warmer soils and drier conditions (shown by the negative slope). In other types of forests (HARV, UNDE), this coupling/ relationship may be weak or even positive depending on sampling time and location.

## Spatial visualization: latitude–longitude colored by pH

```{r}
p_map <- ggplot(soil_env, aes(decimalLongitude, decimalLatitude, color = soilInWaterpH)) +
  geom_point(size = 2) +
  scale_color_viridis_c(option = "plasma") +
  coord_quickmap() +
  labs(x = "Longitude", y = "Latitude", color = "pH (water)",
       title = "Spatial pattern of soil pH across NEON sites") +
  theme_bw()

p_map

```

This map shows the soil pH across latitude and longitude, and highlights biogeographic chemistry patterns.The Western (drier) sites can show higher pH, whereas in humid, organic-rich forests often have a lower pH. The map helps show the relationship between location and chemistry patterns.

## Site-level effect sizes: O vs M differences

```{r}
type_diff <- soil_env %>%
  filter(sample_type %in% c("M","O")) %>%
  group_by(site_ID, sample_type) %>%
  summarize(across(c(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH),
                   ~mean(.x, na.rm = TRUE)), .groups = "drop") %>%
  pivot_wider(names_from = sample_type, values_from = c(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH)) %>%
  mutate(d_temp = soilTemp_O - soilTemp_M,
         d_moist = soilMoisture_O - soilMoisture_M,
         d_phw = soilInWaterpH_O - soilInWaterpH_M,
         d_phc = soilInCaClpH_O - soilInCaClpH_M)

type_diff

```

This, in numbers, shows how the moisture and pH differs when we compare organic horizons to mineral horizons at each site. Negative d_ph shows that the horizons are usually acidic. Positive d_moist shows that none of the horizons are wetter. Overall, this shows a table of the surfaces at specific sites' magnitudes (ex. strongest horizon contrast at UNDE/HARV vs it being weaker at grasslands).

## Pairwise relationships and multicollinearity

```{r}
soil_vars <- soil_env %>%
  select(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH, elevation) %>%
  drop_na()

soil_pairs <- soil_env %>%
  select(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH, elevation) %>%
  drop_na()

# 1. Scatterplot matrix (base R)
pairs(soil_vars,
      main = "Pairwise scatterplots of soil variables",
      pch = 19, col = "steelblue")

# 2. Correlation matrix
cor_matrix <- cor(soil_vars, use = "complete.obs")
print(cor_matrix)



```

Here, we can see correlations among soil variables, linking things like elevation, temperature, and pH. There is a strong negative correlation in which the higher elevation soils are cooler. For the pH water vs pH CaCl₂ there is a strong positive correlation, but CaCl₂ values are consistently lower. For moisture vs temperature it is usually negative in drier sites (makes sense because warmer soils are drier), but may change depending on the site.

## PCA of standardized environmental variables

```{r}

soil_mat <- soil_env %>%
  select(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH, elevation) %>%
  drop_na()

# Run PCA
pca <- prcomp(soil_mat, scale. = TRUE)

# 1. Scree plot (variance explained)
plot(pca, type = "l", main = "Scree plot of PCA")

# 2. Base R biplot
biplot(pca, scale = 0, cex = 0.7)

# 3. ggplot2 version (PC1 vs PC2 scores)
pca_scores <- as.data.frame(pca$x)
pca_scores$site_ID <- soil_env %>%
  drop_na(soilTemp, soilMoisture, soilInWaterpH, soilInCaClpH, elevation) %>%
  pull(site_ID)

ggplot(pca_scores, aes(PC1, PC2, color = site_ID)) +
  geom_point() +
  labs(title = "PCA of soil variables", x = "PC1", y = "PC2") +
  theme_bw()


```

PC1 graphs often show the elevation–temperature gradient. PC2 can separate moisture and pH chemistry. The Scree plot shows how much variance each component explains. The base R biplot displays samples and variable loadings together, it is helpful for quick inspection.The ggplot2 scatterplot is a clean visualization of site clustering in PC1–PC2 space. This can be colored by site, sample type, or any grouping variable.

## Identify chemical outliers and extremes

```{r}
outliers <- soil_env %>%
  mutate(ph_diff = soilInWaterpH - soilInCaClpH) %>%
  mutate(is_extreme = ph_diff > quantile(ph_diff, 0.95, na.rm = TRUE) |
                       ph_diff < quantile(ph_diff, 0.05, na.rm = TRUE) |
                       soilInWaterpH < quantile(soilInWaterpH, 0.05, na.rm = TRUE) |
                       soilInWaterpH > quantile(soilInWaterpH, 0.95, na.rm = TRUE))

outliers %>%
  filter(is_extreme) %>%
  arrange(desc(ph_diff)) %>%
  select(genomicsSampleID, site_ID, soilInWaterpH, soilInCaClpH, ph_diff, soilTemp, soilMoisture, elevation)

```

This shows the samples with extreme water or CaCl₂ pH's, indicating if there are any outliers. For example, a large pH outliers can mean that there is some unusual organic matter. Extremely lower pH samples are most likley from organic-rich forest floors, while very high pHs are found in dry climates (ex. ONAQ).
